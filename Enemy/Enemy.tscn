[gd_scene load_steps=10 format=2]

[ext_resource path="res://Shaders/EnemyLighitng.tres" type="Shader" id=1]
[ext_resource path="res://Enemy/full.png" type="Texture" id=2]
[ext_resource path="res://Player/light.png" type="Texture" id=3]
[ext_resource path="res://Enemy/enemy.wav" type="AudioStream" id=4]

[sub_resource type="GDScript" id=4]
script/source = "extends RigidBody2D


# Declare member variables here. Examples:
# var a = 2
# var b = \"text\"
var blood = preload(\"res://Enemy/Blood.tscn\")
var c : Curve = preload(\"res://enemyLightCurve.tres\");

var PlayerPos : Vector2;
var playerInsight = false;

var light :Light2D;
var tinylight :Light2D;
var noise :AudioStreamPlayer2D;

var stun :float = 0;

func _ready():
	PlayerPos = self.position;
	light = get_node(\"Light2D\");
	noise = get_node(\"noise\");



# Called every frame. 'delta' is the elapsed time since the previous frame.
#func _process(delta):
#	pass
func GetHit():
	for n in 3:
		var instance = blood.instance();
		instance.position = self.position
		instance.rotation = self.rotation;
		get_tree().get_root().get_node(\"Control/ViewportContainer/Viewport/World\").add_child(instance);
	get_node(\"CollisionShape2D\").disabled = true; 
	
	
	queue_free()

func _physics_process(delta):
	if (!is_instance_valid(Player) or Player.dead):return;
	playerInsight = false;
	if stun > 0 :
		stun -= delta;
		return;
	var space_state = get_world_2d().direct_space_state
	# use global coordinates, not local to node
	var result = space_state.intersect_ray(self.position, Player.position,[],5);
	if result and result.collider.name == \"Player\" and (result.collider.position.distance_to(self.position) <150 or Player.FlashOn or Player.GunLight.energy>0.1 or Player.Lit):
		PlayerPos = result.collider.position ;
		playerInsight = true;
	else:
		PlayerPos += Vector2(rand_range(-0.5,0.5),rand_range(-0.5,0.5))*delta
	
	if(playerInsight):
		light.energy = c.interpolate((300 - Player.position.distance_to(self.position))/300);
		noise.pitch_scale = clamp((300 - Player.position.distance_to(self.position))/250,1,5);
	else:
		light.energy = clamp((light.energy-0.1*delta),0,1);
	
	
 #tinylight.energy = clamp(lerp(0,1.5,(400 - Player.position.distance_to(self.position))/400),0,1)
	
	
	noise.pitch_scale = clamp(noise.pitch_scale + rand_range(-0.5,0.5),0.01,100)
	

	#if !(velocity.length() > maxSpeed) :
	#	var target = (PlayerPos - position).normalized();ddddw
	#	if(playerInsight):
	#		velocity += target;
	#	else:
	#		velocity += (Vector2(0,0) - velocity).normalized();
			
	#move_and_slide(velocity);
	
	apply_central_impulse((PlayerPos - position).normalized()*3)
	if Player.position.distance_to(self.position) > 145 and Player.position.distance_to(self.position) < 500:
		apply_central_impulse((PlayerPos - position).normalized()*Player.position.distance_to(self.position)/60)




func _on_Enemy_body_entered(body):
	light.energy += 0.5;
	if body.name == \"Player\":
		Player.Velocity += (PlayerPos - position).normalized()*10
		body.TakeDamage(15);
		apply_central_impulse((position-PlayerPos).normalized()*200)
	if \"reinforced\" in body and !body.reinforced:
		body.GetHit();
		stun = 5;
"

[sub_resource type="ShaderMaterial" id=1]
shader = ExtResource( 1 )
shader_param/magnitude = 100.34

[sub_resource type="CapsuleMesh" id=5]
radial_segments = 15

[sub_resource type="CircleShape2D" id=3]
radius = 17.0

[sub_resource type="OccluderPolygon2D" id=6]
polygon = PoolVector2Array( -4, -1, -3, -3, -1, -4, 1, -4, 3, -3, 4, -1, 4, 1, 3, 3, 1, 4, -1, 4, -3, 3, -4, 1 )

[node name="Enemy" type="RigidBody2D"]
process_priority = 1
collision_layer = 2
collision_mask = 15
gravity_scale = 0.0
contacts_reported = 999
contact_monitor = true
linear_damp = 0.3
angular_damp = 1.0
script = SubResource( 4 )

[node name="MeshInstance2D" type="MeshInstance2D" parent="."]
material = SubResource( 1 )
position = Vector2( 0, -0.500001 )
scale = Vector2( 16, 15.5 )
mesh = SubResource( 5 )
texture = ExtResource( 2 )
__meta__ = {
"_edit_lock_": true
}

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource( 3 )
__meta__ = {
"_edit_lock_": true
}

[node name="Light2D" type="Light2D" parent="."]
scale = Vector2( 0.147461, 0.147461 )
texture = ExtResource( 3 )
color = Color( 0.415686, 0, 0, 1 )
energy = 0.1
shadow_enabled = true
__meta__ = {
"_edit_lock_": true
}

[node name="noise" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource( 4 )
volume_db = 24.0
autoplay = true
max_distance = 500.0
attenuation = 6.72716
__meta__ = {
"_edit_lock_": true
}

[node name="TinyLight" type="Light2D" parent="."]
scale = Vector2( 0.41748, 0.41748 )
texture = ExtResource( 3 )
texture_scale = 0.8
energy = 0.7
shadow_enabled = true
__meta__ = {
"_edit_lock_": true
}

[node name="LightOccluder2D" type="LightOccluder2D" parent="."]
visible = false
light_mask = 0
scale = Vector2( 2, 2 )
occluder = SubResource( 6 )
light_mask = 0

[connection signal="body_entered" from="." to="." method="_on_Enemy_body_entered"]
